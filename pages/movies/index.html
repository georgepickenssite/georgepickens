<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Movie Catalog</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      margin: 0;
      background: #000;
      color: #ccc;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }

    /* main comps */
    .sidebar { width: 80px; background: #0e0f13; border-radius: 20px; margin: 20px; display: flex; flex-direction: column; align-items: center; position: relative; padding-bottom: 10px; }
    .circle-btn { width: 45px; height: 45px; background: #222428; border-radius: 50%; margin: 10px 0; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 18px; cursor: pointer; position: relative; transition: all 0.3s ease; overflow: visible; }
    .circle-btn input { position: absolute; left: 50px; width: 0; opacity: 0; border: none; outline: none; padding: 5px 10px; border-radius: 10px; background: #2b2e33; color: #fff; transition: all 0.3s ease; }
    .circle-btn.active input { height: 20px; width: 200px; opacity: 1; }
    .filter-menu { position: absolute; top: 0; left: 55px; background: #222428; border-radius: 10px; padding: 0; display: flex; flex-direction: row; flex-wrap: wrap; gap: 5px; max-width: 200px; overflow-x: hidden; overflow-y: visible; opacity: 0; pointer-events: none; transition: all 0.3s ease; z-index: 1; }
    .circle-btn.active .filter-menu { max-height: 400px; opacity: 1; padding: 10px; pointer-events: auto; user-select: auto; }
    .filter-menu button { background: #2b2e33; color: #fff; border: none; padding: 5px; border-radius: 6px; white-space: nowrap; cursor: pointer; text-align: left;}
    .filter-menu button:hover { background: #13141a; }
    .scrollbar { flex: 1; width: 100%; display: flex; justify-content: center; margin: 20px 0; position: relative; }
    .track { position: absolute; top: 10px; bottom: 10px; width: 10px; border-radius: 5px; background: #222428; }
    .thumb { width: 55px; height: 35px; background: #222428; border-radius: 10px; position: absolute; top: 0; cursor: grab; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .thumb div { width: 40%; height: 3px; background: #fff; margin: 2px 0; border-radius: 2px; }
    .catalog-frame { flex: 1; margin: 20px; border-radius: 20px; background: #0e0f13; padding: 15px; box-sizing: border-box; display: flex; flex-direction: column; }
    .catalog-inner { flex: 1; border-radius: 15px; background: #13141a; padding: 15px; overflow-y: scroll; scrollbar-width: none; }
    .catalog-inner::-webkit-scrollbar { display: none; }
    .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; }
    .movie-card { background: #222428; border-radius: 15px; padding: 8px; text-align: center; cursor: pointer; }
    .movie-card h3 { font-size: 13px; margin: 5px 0; color: #fff; }
    .movie-card img { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 10px; background: #444; }
    .movie-card p { font-size: 11px; color: #fff; margin: 5px 0 0; }
    #homeBtn { margin-top: auto; }

    /* overlay for movie iframe */
    .movie-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: none;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
    }
    .movie-overlay iframe, .movie-overlay object {
      position: fixed;
      justify-content: center;
      align-items: center;
      width: 80vw;
      height: 80vh;
      border: none;
      border-radius: 12px;
      background: #000;
    }
    .overlay-controls {
      margin-top: 10px;
      display: flex;
      gap: 10px;
    }
    .overlay-controls button {
      background: #222428;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
    }
    .overlay-controls button:hover { background: #2b2e33; }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="circle-btn" id="searchBtn"><i class="fa fa-search"></i><input type="text" id="searchInput" placeholder="Search..."></div>
    <div class="circle-btn" id="filterBtn"><i class="fa fa-filter"></i><div class="filter-menu" id="filterMenu"></div></div>
    <div class="scrollbar"><div class="track"></div><div class="thumb"><div></div><div></div><div></div></div></div>
    <a class="circle-btn" id="homeBtn" href="../../index.html"><i class="fa fa-home"></i></a>
  </div>

  <div class="catalog-frame">
    <div class="catalog-inner" id="movieCatalog">
      <div class="movie-grid" id="movieGrid"></div>
    </div>
  </div>
  
  <!-- Overlay for movies -->
  <div class="movie-overlay" id="movieOverlay">
    <div id="movieContainer"></div>
    <div class="overlay-controls">
      <button onclick="toggleFullscreen()">Fullscreen</button>
      <button onclick="closeOverlay()">Close</button>
    </div>
  </div>

<script>
const SHEET_URL = "https://sheets.googleapis.com/v4/spreadsheets/1nw0SDop0IeFr6q776thp_eSCZZulaxZBtM55ECrHD5A/values/movies?key=AIzaSyBdnupZe6bJH43XE0Hj77n0AmlR3wVfN9M";
const TMDB_API_KEY = "3c3f3d758f294832457405350dda4f89";

const catalog = document.getElementById("movieCatalog");
const thumb = document.querySelector(".thumb");
const movieGrid = document.getElementById("movieGrid");
const track = document.querySelector(".track");
const searchBtn = document.getElementById("searchBtn");
const searchInput = document.getElementById("searchInput");
const filterBtn = document.getElementById("filterBtn");
const filterMenu = document.getElementById("filterMenu");
const overlay = document.getElementById("movieOverlay");
const movieContainer = document.getElementById("movieContainer");

let allMovies = [];
let categories = new Set();

// TMDB genre mapping
const genreMap = {
  28: "Action", 12: "Adventure", 16: "Animation", 35: "Comedy", 80: "Crime",
  99: "Documentary", 18: "Drama", 10751: "Family", 14: "Fantasy", 36: "History",
  27: "Horror", 10402: "Music", 9648: "Mystery", 10749: "Romance", 878: "Science Fiction",
  10770: "TV Movie", 53: "Thriller", 10752: "War", 37: "Western"
};

// build long date string (yesterday + today + tomorrow)
function getDateString() {
  const d = new Date();
  const fmt = dt => dt.toISOString().split("T")[0].replace(/-/g, "");
  const y = new Date(d); y.setDate(d.getDate() - 1);
  const t = new Date(d); t.setDate(d.getDate() + 1);
  return fmt(y) + fmt(d) + fmt(t);
}

function buildMovieURL(base, imdbID) {
  const longDate = getDateString();
  return {
    url: base + longDate,
    subs: "https://rips.cc/subs/" + imdbID + ".vtt"
  };
}

// Fetch movie data from TMDB using IMDb ID
async function fetchMovieByImdb(imdbID) {
  const url = `https://api.themoviedb.org/3/find/${imdbID}?api_key=${TMDB_API_KEY}&language=en-US&external_source=imdb_id`;
  const res = await fetch(url);
  const data = await res.json();
  const movie = data.movie_results[0];
  if (!movie) return null;
  return {
    title: movie.title,
    overview: movie.overview,
    genres: movie.genre_ids.map(id => genreMap[id] || "Unknown"),
    poster: movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : "",
    imdbID
  };
}

// Fetch multiple movies
async function fetchMovies(imdbIDs) {
  const promises = imdbIDs.map(id => fetchMovieByImdb(id));
  const results = await Promise.all(promises);
  return results.filter(m => m !== null);
}

// Fetch movies and build catalog
async function fetchMovieData() {
  try {
    const sheetRes = await fetch(SHEET_URL).then(r => r.json());
    const rows = sheetRes.values;
    const headers = rows.shift();
    const urlIndex = headers.indexOf("URL");
    const subsIndex = headers.indexOf("Subtitles");

    const imdbIDs = rows.map(r => r[subsIndex]);
    const moviesFromTMDB = await fetchMovies(imdbIDs);

    allMovies = rows.map(r => {
      const imdbID = r[subsIndex];
      const baseURL = r[urlIndex];
      const match = moviesFromTMDB.find(m => m.imdbID === imdbID);
      if (match) return { ...match, baseURL, subs: imdbID };
      else return { title: "Database Error", overview: "No data found for IMDb ID " + imdbID, genres: ["Database Error"], poster: "", baseURL, subs: imdbID };
    });

    categories = new Set();
    allMovies.forEach(m => m.genres.forEach(g => categories.add(g)));

    buildFilters();
    renderMovies(allMovies);
  } catch (e) {
    console.error("Error fetching TMDB data", e);
  }
}

// Render movie cards
function renderMovies(movies) {
  movieGrid.innerHTML = "";
  movies.forEach(movie => {
    const card = document.createElement("div");
    card.className = "movie-card";

    if (movie.poster) {
      card.innerHTML = `
        <h3>${movie.title}</h3>
        <img src="${movie.poster}" alt="${movie.title}">
        <p>${movie.genres.join(", ")}</p>
      `;
    } else {
      card.innerHTML = `
        <h3>${movie.title}</h3>
        <div style="background:#444; color:#fff; padding:20px; border-radius:10px;">
          Database Error
        </div>
        <p>${movie.genres.join(", ")}</p>
      `;
    }

    card.addEventListener("click", () => openOverlay(movie));
    movieGrid.appendChild(card);
  });
}

// Build filter buttons
function buildFilters() {
  filterMenu.innerHTML = "";
  const allBtn = document.createElement("button");
  allBtn.textContent = "All";
  allBtn.onclick = () => renderMovies(allMovies);
  filterMenu.appendChild(allBtn);
  categories.forEach(cat => {
    const btn = document.createElement("button");
    btn.textContent = cat;
    btn.onclick = () => renderMovies(allMovies.filter(m => m.genres.includes(cat)));
    filterMenu.appendChild(btn);
  });
}

// Open movie overlay
function openOverlay(movie) {
  const links = buildMovieURL(movie.baseURL, movie.subs);
  movieContainer.innerHTML = `
    <video id="videoplayer" class="embed" controls>
      <source id="vidsource" src="${links.url}" type="video/mp4">
      <track id="subs" kind="subtitles" src="${links.subs}" srclang="en" default>
    </video>
    <h2 style="text-align:center;margin-top:10px;">${movie.title}</h2>
    <p style="max-width:80%;margin:auto;text-align:center;white-space:normal;">${movie.overview}</p>
  `;
  overlay.style.display = "flex";
}

function closeOverlay() {
  overlay.style.display = "none";
  movieContainer.innerHTML = "";
}

function toggleFullscreen() {
  const el = document.querySelector("#videoplayer");
  if (!el) return;
  if (!document.fullscreenElement) {
    el.requestFullscreen().catch(err => console.error(err));
  } else {
    document.exitFullscreen();
  }
}

// --- Sidebar behavior ---
// Scrollbar thumb sync
function syncThumb() {
  const ratio = catalog.scrollTop / (catalog.scrollHeight - catalog.clientHeight);
  const trackHeight = track.clientHeight - thumb.clientHeight;
  thumb.style.top = (track.offsetTop + ratio * trackHeight) + "px";
}
catalog.addEventListener("scroll", syncThumb);

let dragging = false, startY, startTop;
thumb.addEventListener("mousedown", e => {
  dragging = true;
  startY = e.clientY;
  startTop = parseInt(thumb.style.top) || 0;
  thumb.style.cursor = "grabbing";
});
document.addEventListener("mousemove", e => {
  if (!dragging) return;
  const dy = e.clientY - startY;
  const trackHeight = track.clientHeight - thumb.clientHeight;
  let newTop = Math.min(track.offsetTop + trackHeight, Math.max(track.offsetTop, startTop + dy));
  thumb.style.top = newTop + "px";
  const ratio = (newTop - track.offsetTop) / trackHeight;
  catalog.scrollTop = ratio * (catalog.scrollHeight - catalog.clientHeight);
});
document.addEventListener("mouseup", () => { dragging = false; thumb.style.cursor = "grab"; });

// Search
searchBtn.addEventListener("click", () => {
  searchBtn.classList.toggle("active");
  if (searchBtn.classList.contains("active")) {
    searchInput.focus();
  } else {
    searchInput.value = "";
    renderMovies(allMovies);
  }
});
searchInput.addEventListener("input", e => {
  const term = e.target.value.toLowerCase();
  renderMovies(allMovies.filter(m => m.title.toLowerCase().includes(term)));
});

// Filter toggle
filterBtn.addEventListener("click", () => {
  filterBtn.classList.toggle("active");
});

// Escape to close overlay
document.addEventListener("keydown", e => {
  if (e.key === "Escape" && overlay.style.display === "flex") closeOverlay();
});

fetchMovieData();
</script>


</body>
</html>
